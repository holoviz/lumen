{% extends 'BaseLumenAgent/revise_output.jinja2' %}

{% block instructions %}
# SCOPE: Polish the existing Vega-Lite spec to improve clarity, formatting, and usability.

CRITICAL: The spec uses layers. When updating a layer, you MUST include both `mark` and `encoding`.
Even if only adding tooltips, copy the existing mark. Each layer requires both properties.

# GENERAL POLISHING GUIDELINES

## Formatting & Readability
- Drop unnecessary decimal points: use `.0f` instead of `.1f` when precision isn't needed
- Add comma separators for large numbers: use `',.0f'` instead of `.0f`
- Keep formatting consistent across tooltips, axes, and labels
- Remove redundant subtitle text (e.g., "sorted descending" is obvious from the visual)

## Data Density & Focus
- For categorical plots with many items (20+), limit to top 10-20 for scannability
- Use transform/filter to focus on most relevant data:
  ```yaml
  transform:
  - window:
    - op: rank
      as: rank
    sort:
    - field: value
      order: descending
  - filter: datum.rank <= 15
  ```

## Make the Takeaway Explicit
- Titles should state the insight, not just describe the chart
  - ❌ "Revenue by Region"
  - ✅ "APAC revenue grew fastest in 2025"
  - ❌ "Top States by Average Wind Turbine Capacity"
  - ✅ "New Mexico leads the nation in wind turbine capacity"
- Use the subtitle for additional context or methodology
- Lead with what matters most to the audience

## Order and Group Logically
- Sort data to reinforce the story:
  - Largest → smallest for rankings
  - Chronological for time series
  - Before → after for comparisons
- Use `sort: -x` or `sort: {field: value, order: descending}` appropriately
- Group related items visually so patterns emerge naturally
- Consider using color or spacing to create visual groups

## Annotations > Legends
- Label data directly on the chart where possible using text marks
- Direct labels reduce eye movement and interpretation effort
- Use annotations to highlight key insights or outliers
- Reserve legends only when direct labeling isn't feasible (many categories, overlapping labels)
- Example: Add text layer for bar labels instead of relying on axis alone

## Strategic Use of Color
- Reserve color to highlight what matters most
- For single-message charts, use one accent color for the key insight, neutral colors for rest
- For quantitative data, use color gradients to show magnitude:
  ```yaml
  color:
    field: value
    type: quantitative
    scale:
      scheme: blues  # or greens, oranges, reds, etc.
    legend: null
  ```
- Be consistent: same colors should mean the same thing across related charts
- Be accessible: use colorblind-safe palettes (avoid red-green combinations)
- Default schemes like 'blues', 'greens', 'oranges' are generally colorblind-safe

## Text Labels on Charts
- For bar charts with labels, ensure labels don't extend beyond tiny bars
- Consider conditional placement or removing labels for very small values
- Adjust `dx` spacing (typically 5) and `fontSize` (typically 11) for readability
- Use darker text colors like `'#333333'` instead of pure black for better aesthetics

## Axis Scaling
- Set explicit domains to avoid excessive whitespace: `scale: {domain: [0, max_value]}`
- Only set domains when the auto-scaling creates poor visualizations

## Typography
- Increase title fontSize to 18 for better hierarchy
- Increase subtitle fontSize to 13 for readability
- Use font weights to create visual hierarchy where appropriate

{% endblock %}

{% block examples %}
# EXAMPLES

Drop unnecessary decimal points:
```yaml
- encoding:
    text:
      format: .0f
```

Clean up scientific notation:
```yaml
layer:
- encoding:
    x:
      axis:
        format: ',.0f'
```

Limit to top N categories:
```yaml
transform:
- window:
  - op: rank
    as: rank
  sort:
  - field: average_capacity_kw
    order: descending
- filter: datum.rank <= 15
```

Insight-driven titles:
```yaml
title:
  anchor: start
  fontSize: 18
  text: "New Mexico leads the nation in wind turbine capacity"
  subtitle: "Average capacity per state, 2024"
  subtitleColor: '#666666'
  subtitleFontSize: 13
```

Strategic color highlighting (accent one category):
```yaml
layer:
- mark: bar
  encoding:
    color:
      condition:
        test: datum.state == 'NM'
        value: '#1f77b4'  # Highlight color
      value: '#cccccc'  # Neutral gray for others
    x: {field: value, type: quantitative}
    y: {field: state, type: nominal, sort: -x}
```

Color gradient for quantitative magnitude:
```yaml
layer:
- mark: bar
  encoding:
    color:
      field: value
      type: quantitative
      scale:
        scheme: blues  # Colorblind-safe gradient
      legend: null
    x: {field: category, type: ordinal}
    y: {field: value, type: quantitative}
```

Direct labeling with text layer (annotations > legends):
```yaml
layer:
- mark: bar
  encoding:
    x: {field: value, type: quantitative}
    y: {field: category, type: nominal}
- mark:
    type: text
    align: left
    color: '#333333'
    dx: 5
    fontSize: 11
  encoding:
    text:
      field: value
      format: ',.0f'
      type: quantitative
    x: {field: value, type: quantitative}
    y: {field: category, type: nominal}
```

Logical sorting (largest to smallest):
```yaml
encoding:
  y:
    field: state
    type: nominal
    sort: -x  # Sort by x-axis value descending
```

Bar chart with tooltips (in layered spec):
```yaml
layer:
  - mark: bar  # MUST include mark even when only adding tooltips
    encoding:
      x: {field: state, type: ordinal}
      y: {field: avg_pcap, type: quantitative}
      tooltip:  # Add tooltips to existing encoding
      - field: state
        title: State
        type: ordinal
      - field: avg_pcap
        format: ',.0f'  # Consistent formatting with comma separator
        title: Avg Power Capacity
        type: quantitative
```

Line chart with tooltips (in layered spec):
```yaml
layer:
  - mark:  # MUST include mark even when only adding tooltips
      type: line
      point: true
      tooltip: true
    encoding:
      x: {field: year, type: quantitative}
      y: {field: value, type: quantitative}
      tooltip:  # Add tooltips to existing encoding
      - field: year
        title: Year
        type: quantitative
      - field: value
        format: ',.2f'  # Appropriate precision with comma separator
        title: Value
        type: quantitative
```
{% endblock %}

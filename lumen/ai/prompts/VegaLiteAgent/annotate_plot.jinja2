{% extends 'VegaLiteAgent/improvement_step.jinja2' %}

{% block instructions %}
Add strategic visual annotations to highlight key insights in your data.

# SCOPE: Telling a Clear Story

# Annotation Strategy

Aim for 2-4 annotations that support your narrative. Best annotations:
- Mark meaningful thresholds (not arbitrary averages unless they tell a story)
- Highlight exceptional ranges or critical time periods
- Clarify events that explain patterns

Avoid:
- Obvious patterns already clear from the visual
- Statistical measures (mean, median) unless they're meaningful thresholds
- Annotations that compete with or obscure the data
- Floating annotations disconnected from the data (e.g., text at y=0 for a bar chart)

**Key principle**: If the visualization already tells the story clearly through color, sorting, or visual encoding, you may not need annotations at all.

# Annotation Patterns

**Reference lines**: Horizontal/vertical rules for meaningful thresholds
- Use for goals, benchmarks, or natural breakpoints (e.g., "5,000+ turbines = major wind state")
- Position with `y: {datum: value}` or `x: {datum: value}`
- Use subtle styling: `opacity: 0.5`, muted colors, thin lines
- Anchor labels to the line, not floating positions

**Value labels**: Text on specific data points
- Use only for outliers or endpoints that need emphasis
- Apply `transform` with `filter` to select points
- Don't label every bar - let the axis provide that information

**Conditional highlights**: Emphasize data meeting criteria
- Layer filtered data with distinct color
- Use `transform: [{filter: "datum.field > threshold"}]`
- Make sure the threshold is meaningful, not arbitrary
{% endblock %}

{% block examples %}
# EXAMPLES

Reference line with subtle styling:
```yaml
layer:
  - mark: bar
    encoding:
      x: {field: category, type: ordinal}
      y: {field: value, type: quantitative}
  - mark: {type: rule, color: '#666666', size: 1, strokeDash: [4,4], opacity: 0.5}
    encoding:
      y: {datum: 5000}
  - mark: {type: text, align: left, dx: 5, dy: -5, fontSize: 10, color: '#666666'}
    encoding:
      text: {value: "5,000"}
      y: {datum: 5000}
      x: {datum: 0}
```

Value labels with filter:
```yaml
layer:
  - mark: line
    encoding:
      x: {field: year, type: ordinal}
      y: {field: value, type: quantitative}
  - mark: {type: text, align: left, dx: 5, fontSize: 11}
    transform:
      - filter: "datum.year == 2022"  # Only label final point
    encoding:
      x: {field: year, type: ordinal}
      y: {field: value, type: quantitative}
      text: {field: value, type: quantitative, format: ".0f"}
```

Conditional highlighting:
```yaml
layer:
  - mark: bar
    encoding:
      x: {field: category, type: nominal}
      y: {field: value, type: quantitative}
  - mark: {type: bar, color: "#e74c3c"}
    transform:
      - filter: "datum.value > 500"
    encoding:
      x: {field: category, type: nominal}
      y: {field: value, type: quantitative}
```
{% endblock %}

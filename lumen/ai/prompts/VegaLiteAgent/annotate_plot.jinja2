{% extends 'VegaLiteAgent/improvement_step.jinja2' %}

{% block instructions %}
Add visual annotations using layers to highlight key insights.

# SCOPE: Annotations via Layers

Annotation types:
- Reference lines (rules) with labels for thresholds/means/goals
- Highlighted rectangles for time periods or ranges
- Value labels (text) on bars/points
- Conditional highlighting using filters and y2 encoding

CRITICAL RULES:
- Each layer needs both `mark` and `encoding`
- Properties like `opacity` go inside mark: `mark: {type: bar, opacity: 0.75}`
- Reference lines: `y: {datum: 30}` (horizontal) or `x: {datum: 5}` (vertical)
- Text positioning: `x: {value: 0}` for edges, NOT pixel values
- Annotations must support your title/subtitle narrative
{% endblock %}

{% block examples %}
Reference line with label:
```yaml
layer:
  - mark: bar
    encoding:
      x: {field: category, type: ordinal}
      y: {field: value, type: quantitative}
  - mark: {type: rule, color: red, size: 3}
    encoding:
      y: {datum: 30}
  - mark: {type: text, align: left, baseline: top, dx: 5, dy: 5, fontSize: 12}
    encoding:
      text: {value: "Target: 30"}
      y: {datum: 30}
      x: {value: 0}
```

Highlighted bars above threshold:
```yaml
layer:
  - mark: bar
    encoding:
      x: {field: Day, type: ordinal}
      y: {field: Value, type: quantitative}
  - mark: bar
    transform:
      - filter: "datum.Value >= 300"
      - calculate: "300"
        as: baseline
    encoding:
      x: {field: Day, type: ordinal}
      y: {field: baseline, type: quantitative}
      y2: {field: Value}
      color: {value: "#c0392b"}
  - mark: {type: rule, color: red, size: 2}
    encoding:
      y: {datum: 300}
  - mark: {type: text, align: right, baseline: bottom, dx: -2, dy: -2, x: width}
    encoding:
      text: {value: "hazardous"}
      y: {datum: 300}
```

Value labels on bars:
```yaml
layer:
  - mark: {type: bar, opacity: 0.75}
    encoding:
      x: {field: category, type: nominal}
      y: {field: value, type: quantitative}
  - mark: {type: text, align: center, baseline: bottom, dy: -5, fontSize: 14}
    encoding:
      x: {field: category, type: nominal}
      y: {field: value, type: quantitative}
      text: {field: value, type: quantitative, format: ".0f"}
      color: {value: "#333"}
```

Highlighted time periods:
```yaml
layer:
  - mark: rect
    data:
      values:
        - {start: "1933", end: "1945", event: "Nazi Rule"}
    encoding:
      x: {field: start, timeUnit: year}
      x2: {field: end, timeUnit: year}
      color: {field: event, type: nominal}
  - mark: line
    encoding:
      x: {field: year, timeUnit: year}
      y: {field: population, type: quantitative}
```
{% endblock %}

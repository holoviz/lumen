{% extends 'LumenBaseAgent/retry_output.jinja2' %}

{% block instructions %}
Add strategic visual annotations to highlight key insights.

# LAYERS

Wrap chart in `layer` array, then add annotation marks (rules, text, highlights). All layers share data/scales unless overridden.

# PATTERNS

**Reference lines**: Horizontal/vertical rules for thresholds (goals, benchmarks)
- Position: `y: {datum: value}` or `x: {datum: value}`
- Style: subtle colors, `opacity: 0.5`, `strokeDash: [4,4]`
- Anchor labels to line

**Value labels**: Text on outliers/endpoints only
- Filter: `transform: [{filter: "datum.field > threshold"}]`
- Don't label every pointâ€”let axes handle that

**Conditional highlights**: Emphasize data meeting criteria
- Layer filtered data with distinct color
- Use meaningful thresholds
{% endblock %}

{% block examples %}
# EXAMPLES

## Converting to layers (reference line):

Before:
```yaml
mark: bar
encoding:
  x: {field: category, type: ordinal}
  y: {field: value, type: quantitative}
```

After:
```yaml
layer:
  - mark: bar
    encoding:
      x: {field: category, type: ordinal}
      y: {field: value, type: quantitative}
  - mark: {type: rule, color: '#666', size: 1, strokeDash: [4,4], opacity: 0.5}
    encoding: {y: {datum: 5000}}
  - mark: {type: text, align: left, dx: 5, dy: -5, fontSize: 10, color: '#666'}
    encoding:
      text: {value: "5,000"}
      y: {datum: 5000}
      x: {datum: 0}
```

## Value labels with filter:
```yaml
layer:
  - mark: line
    encoding:
      x: {field: year, type: ordinal}
      y: {field: value, type: quantitative}
  - mark: {type: text, align: left, dx: 5, fontSize: 11}
    transform: [{filter: "datum.year == 2022"}]
    encoding:
      x: {field: year, type: ordinal}
      y: {field: value, type: quantitative}
      text: {field: value, type: quantitative, format: ".0f"}
```

## Conditional highlighting:
```yaml
layer:
  - mark: bar
    encoding:
      x: {field: category, type: nominal}
      y: {field: value, type: quantitative}
  - mark: {type: bar, color: "#e74c3c"}
    transform: [{filter: "datum.value > 500"}]
    encoding:
      x: {field: category, type: nominal}
      y: {field: value, type: quantitative}
```
{% endblock %}

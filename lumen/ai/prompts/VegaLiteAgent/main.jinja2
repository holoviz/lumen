{% extends 'BaseViewAgent/main.jinja2' %}

{% block instructions %}
Generate complete, effective Vega-Lite visualizations that clearly communicate data insights.

# ESSENTIAL STRUCTURE

Every visualization must:
- Use `data: {name: {{ memory['table'] }}}` with exact column names from source
- Use the simplest structure that works:
  - **Simple single-mark charts**: Use flat `mark` + `encoding` (no layer needed)
  - **Multiple marks/overlays**: Wrap in `layer` array, each with its own `mark` and `encoding`
- Focus on ONE primary metric or relationship per chart
- Include narrative titles that highlight key insights from the data
- Do not overcrowd the plot with too many data points, especially for bars

# WHEN TO USE LAYERS

**Use flat structure (NO layer)** for:
- Single mark type (bar, line, point, area, etc.)
- Simple charts with one visualization layer

**Use layer array** when you need:
- Multiple mark types overlaid (line + points, bar + line, etc.)
- Annotations or reference lines on top of data
- Multiple data series with different encodings

# MARK vs ENCODING

This is the most common source of errors. Properties belong in different places:

**Mark** (static styling): Position (`dx`, `dy`, `align`, `baseline`) and style (`color`, `opacity`, `fontSize`) go here
```yaml
mark: {type: text, align: left, dx: 3, color: black}
```

**Encoding** (data mappings): Fields and channels (`x`, `y`, `color`, `size`, `text`) go here
```yaml
encoding:
  x: {field: year, type: quantitative}
  color: {value: 'blue'}  # Static values need {value: ...}
```

# LEGENDS

Legends appear when you map data to `color`, `size`, or `shape` in encoding.

**Single field**: Map directly
**Multiple series**: Use `transform` to create a constant field, then map it (never use `datum` in color encoding)

# KEY PATTERNS

**Sort rankings**: `sort: "-x"` (horizontal) or `sort: "-y"` (vertical) on the categorical axis

**Color purposefully**: Encode dimensions, highlight outliers/leaders, or show thresholds. Keep color in `mark` for text labels that shouldn't appear in legends.

**Informative titles**: Main title states what's shown, subtitle reveals the key insight or pattern

**Data types**: Match type to your data - quantitative for continuous, ordinal for ordered categories, nominal for unordered, temporal for dates
{% endblock %}

{% block examples %}
# EXAMPLES
{% if doc_examples is defined and doc_examples %}
{% for example in doc_examples %}
{{ example }}
{% endfor %}
{% endif %}

Simple bar chart (flat structure):
```yaml
title:
  anchor: start
  fontSize: 20
  subtitle: "Texas leads with over 15,000 turbines deployed"
  subtitleColor: '#666666'
  subtitleFontSize: 16
  text: "Wind Turbine Deployment by State"
data:
  name: <TABLE_NAME>
mark: bar
encoding:
  y:
    field: state
    type: nominal
    sort: "-x"
    axis:
      title: "State"
  x:
    field: turbine_count
    type: quantitative
    axis:
      title: "Number of Turbines"
  color:
    condition:
      test: "datum.state === 'TX'"
      value: '#1f77b4'
    value: '#aec7e8'
  tooltip:
    - field: state
      type: nominal
      title: State
    - field: turbine_count
      type: quantitative
      title: Turbines
      format: ",d"
```
{% endblock %}

{% block errors %}
{{ super() }}

{% if errors is defined and errors %}
For extra context, here are the data and columns available:
{{ columns_context }}
{% endif %}
{% endblock %}

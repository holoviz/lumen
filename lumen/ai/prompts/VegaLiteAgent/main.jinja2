{% extends 'BaseViewAgent/main.jinja2' %}

{% block instructions %}
Generate effective Vega-Lite visualizations that clearly communicate data insights.

# CHART TYPE SELECTION

Choose the right chart based on your data:

| Data Pattern | Chart Type | Key Settings |
|-------------|------------|---------------|
| Ranking/comparison | Horizontal bar | `sort: -x`, limit top 10 |
| Timeline/events | Scatter/point on time axis | `scale: {domain: [start, end]}`, sort by date |
| Trend over time | Line chart | `type: temporal` or quantitative with format |
| Part-to-whole | Stacked bar | `color` encodes category |
| Correlation | Scatter plot | Both axes quantitative |
| Geographic | Map with lat/long | `projection`, use `longitude`/`latitude` encodings |

# CRITICAL RULES

1. **Data reference**: `data: {name: {{ memory['table'] }}}` with exact column names
2. **Layer structure**: ALWAYS wrap marks in `layer` array—never use top-level `mark` + `encoding`
3. **Quote field names**: Field names with spaces, commas, or special chars MUST be quoted: `field: "GDP per capita, PPP (2021 $)"`
4. **Tooltip is an array**: `tooltip: [{field: x}, {field: y}]` NOT `tooltip: {a: {field: x}}`
5. **Mark vs Encoding**: `dx`, `dy`, `align`, `baseline` go in `mark` only, NEVER in encoding
6. **Scale domains**: Set explicit domain when data doesn't start at 0 (e.g., years 1896-2022 need `scale: {domain: [1890, 2025]}`)
7. **Sort appropriately**: Rankings by value (`sort: -x`), timelines by date (`sort: {field: date_field}`)
8. **Limit categories**: More than 10 items? Filter to top 10 with window transform
9. **Title with subtitle**: Use `title: {text: "...", subtitle: "..."}` to convey insights, not just topic

# KEY PATTERNS

**Year fields**: Use `type: quantitative` with `axis: {format: 'd'}` to prevent comma separators

**Timelines**: 
- X-axis = time with proper domain, NOT starting at 0
- Sort by date field, NOT alphabetically
- Color can encode categories (e.g., season, type)

**Highlight leader**: `condition: {test: "datum.rank === 1", value: '#1f77b4'}`

**Clean styling**: `config: {view: {stroke: null}}`, minimal gridlines

**Geographic maps**: Use `longitude`/`latitude` encodings (NOT `x`/`y`). Data MUST have coordinate columns.
{% endblock %}

{% block examples %}
# EXAMPLES
{% if doc_examples is defined and doc_examples %}
{% for example in doc_examples %}
{{ example }}
{% endfor %}
{% endif %}

Basic scatter with special characters in field names:
```yaml
data:
  name: <TABLE_NAME>
layer:
  - mark: {type: circle, opacity: 0.7}
    encoding:
      x: {field: "GDP per capita, PPP (constant 2021 $)", type: quantitative}
      y: {field: "Life expectancy at birth", type: quantitative}
      tooltip:
        - {field: Entity, type: nominal, title: Country}
        - {field: "GDP per capita, PPP (constant 2021 $)", type: quantitative}
```

Mark vs Encoding (common error—dx/dy go in mark, NOT encoding):
```yaml
layer:
  # ✅ CORRECT: dx in mark
  - mark: {type: text, align: left, dx: 5, color: black}
    encoding:
      x: {field: value, type: quantitative}
      y: {field: category, type: nominal}
      text: {field: value, type: quantitative}
  # ❌ WRONG: dx in encoding causes validation error
  # - mark: text
  #   encoding:
  #     dx: {value: 5}  # INVALID - dx is not an encoding channel
```

Window transform structure (common error—sort is INSIDE window, not a separate transform):
```yaml
# ✅ CORRECT: sort is a property OF the window transform
transform:
  - window: [{op: rank, field: value, as: rank}]
    sort: [{field: value, order: descending}]
  - filter: datum.rank <= 10

# ❌ WRONG: sort as a sibling key causes validation error
# transform:
#   - sort: [{field: value, order: descending}]  # INVALID - not a transform type
#     window: [{op: rank, field: value, as: rank}]
```

Title with subtitle:
```yaml
title:
  text: "Sales Spiked 40% in Q3"  # What happened, not "Sales Over Time"
  subtitle: "Online channels drove 80% of growth"  # New insight, don't repeat title
  fontSize: 18
  subtitleFontSize: 14
  subtitleColor: '#666666'
  anchor: start
```

Modifying existing title:
```yaml
old_str: |
  title:
    text: GDP vs Life Expectancy
new_str: |
  title:
    text: Higher GDP Correlates with Longer Life
    subtitle: 204 countries, 1990-2023
```

Simple time series with endpoint labels:
```yaml
data:
  name: <TABLE_NAME>
transform:
  - window:
    - {op: min, field: year, as: minYear}
    - {op: max, field: year, as: maxYear}
    frame: [null, null]
layer:
  - mark: {type: line, point: true}
    encoding:
      x: {field: year, type: quantitative, axis: {format: 'd'}}
      y: {field: avg_capacity, type: quantitative}
  - transform: [{filter: datum.year === datum.minYear || datum.year === datum.maxYear}]
    mark: {type: text, align: left, dx: 5, dy: -5}
    encoding:
      x: {field: year, type: quantitative}
      y: {field: avg_capacity, type: quantitative}
      text: {field: avg_capacity, type: quantitative}
      color: {value: black}
```

Ranked bar chart with top 10 filter:
```yaml
data:
  name: <TABLE_NAME>
transform:
  - window: [{op: rank, field: turbine_count, as: rank}]
    sort: [{field: turbine_count, order: descending}]
  - filter: datum.rank <= 10
layer:
  - mark: bar
    encoding:
      y: {field: state, type: nominal, sort: "-x", axis: {title: null}}
      x: {field: turbine_count, type: quantitative, axis: {title: "Number of Turbines", format: ","}}
      color:
        condition: {test: "datum.rank === 1", value: '#1f77b4'}
        value: '#aec7e8'
config:
  view: {stroke: null}
  axisX: {gridColor: '#eeeeee'}
  axisY: {grid: false}
```

Geographic scatter:
```yaml
data:
  name: <TABLE_NAME>
layer:
  - mark: {type: circle, opacity: 0.7}
    encoding:
      longitude: {field: xlong, type: quantitative}
      latitude: {field: ylat, type: quantitative}
      size: {field: capacity_kw, type: quantitative, scale: {range: [100, 500]}, legend: {title: "Capacity (kW)"}}
      color: {value: '#1f77b4'}
      tooltip:
        - {field: turbine_id, type: nominal, title: "ID"}
        - {field: capacity_kw, type: quantitative, title: "Capacity (kW)"}
```

Multi-line with selective emphasis:
```yaml
data:
  name: <TABLE_NAME>
layer:
  - transform: [{filter: "datum.category != 'primary' && datum.category != 'secondary'"}]
    mark: {type: line, opacity: 0.2, strokeWidth: 1}
    encoding:
      x: {field: year, type: quantitative, axis: {format: 'd'}}
      y: {field: value, type: quantitative}
      color: {field: category, type: nominal, legend: null}
  - transform: [{filter: "datum.category == 'primary'"}]
    mark: {type: line, opacity: 1, strokeWidth: 3}
    encoding:
      x: {field: year, type: quantitative}
      y: {field: value, type: quantitative}
      color: {value: '#d62728'}
config:
  view: {stroke: null}
  axisX: {grid: false}
  axisY: {gridColor: '#eeeeee'}
```

Dual encoding (size + color for different metrics):
```yaml
data:
  name: <TABLE_NAME>
layer:
  - mark: {type: circle, opacity: 0.7}
    encoding:
      longitude: {field: xlong, type: quantitative}
      latitude: {field: ylat, type: quantitative}
      size: {field: capacity_kw, type: quantitative}
      color: {field: efficiency_pct, type: quantitative, scale: {scheme: viridis, domain: [85, 95]}, legend: {title: "Efficiency (%)"}}
```

Bar chart with legend:
```yaml
data:
  name: <TABLE_NAME>
layer:
  - mark: bar
    encoding:
      x: {field: category, type: nominal}
      y: {field: sales, type: quantitative}
      color: {field: category, type: nominal, legend: {title: "Category", orient: "right"}}
```

Choropleth map (US states):
```yaml
data:
  url: "https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"
  format: {type: topojson, feature: states}
transform:
  - lookup: "properties.name"
    from:
      data: {name: <TABLE_NAME>}
      key: state_name
      fields: [population]
mark: geoshape
projection: {type: albersUsa}
encoding:
  color: {field: population, type: quantitative, scale: {scheme: blues}, legend: {title: "Population"}}
  tooltip:
    - {field: "properties.name", type: nominal, title: "State"}
    - {field: population, type: quantitative, format: ",", title: "Population"}
```

Choropleth map (world countries):
```yaml
data:
  url: "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"
  format: {type: topojson, feature: countries}
transform:
  - lookup: "properties.name"
    from:
      data: {name: <TABLE_NAME>}
      key: country
      fields: [value]
mark: {type: geoshape, stroke: white, strokeWidth: 0.5}
projection: {type: equalEarth}
encoding:
  color:
    condition:
      test: datum.value != null
      field: value
      type: quantitative
      scale: {scheme: blues}
    value: '#e0e0e0'
  tooltip:
    - {field: "properties.name", type: nominal, title: "Country"}
    - {field: value, type: quantitative, title: "Value"}
```
{% endblock %}

{% block context %}
Available visualization types:
{{ doc }}

The current SQL table name: {{ memory['pipeline'].table }}.

Here is the current dataset to use:
{{ memory['data'] }}

{%- if "view" in memory %}
The previous view specification was:
```yaml
{{ memory["view"]["spec"] | json_to_yaml }}
```
{%- endif %}

{% if memory['pipeline'].source.dialect == "snowflake" %}
Please use all upper case for field names.
{% endif %}
{%- endblock %}

{% extends 'Agent/main.jinja2' %}

{%- block instructions %}
# Instructions:
Determine discovery steps needed to answer the user's query.

## Query Classification:

DIRECT QUERIES (Quick schema check + answer):
- Table display: "show table", "display data", "show me the table"
- Simple aggregations: "count rows", "sum totals", "top athletes"
- Structure queries: "what columns", "describe table"
- Ranking/filtering: "most/least", "top N"

→ Direct execution without discovery steps

ENTITY DISCOVERY QUERIES (Focused discovery needed):
- Specific entity filters with unknown values
- Names, places, companies needing pattern discovery
- Complex entity combinations

→ Systematic discovery with small token limits

## Critical Rule: Schema Verification Required
- User terms may not match actual schema
- Column names/enum values may differ from expected
- ALWAYS verify column names and enum values first

## Discovery Rules:

Query Limits:
- Structure: LIMIT 3-5
- Value discovery: LIMIT 20-50
- Final answers: No limit for SHOW commands
- Always exclude NULLs

Pattern Discovery:
```sql
SELECT DISTINCT "column"
FROM "table"
WHERE "column" ILIKE '%pattern%' AND "column" IS NOT NULL
LIMIT 20;
```

## Step Planning:
1. Direct: Single step with final answer
2. Discovery: Structure check → Value discovery → Final analysis
3. Complex: 2-3 focused steps maximum
4. Be token conscious - results inject back into context

{% endblock %}

{% block examples %}
Examples:

Direct (No steps needed):
"Show me the data table" → ['Display the data table']
"Show the table" → ['Display the table contents']

Analysis (Structure check first):
"Which entity has the most metric?" → ['Check structure (LIMIT 3)', 'Count metric by entity']

Discovery:
"Show records for [Name]" → ['Find name variations (LIMIT 30)', 'Display matching records']
{% endblock %}

{% block context %}
Please analyze the data context below and provide discovery steps:

{%- if previous_sql_plan_results is defined and previous_sql_plan_results %}
Previous Results:
{{ previous_sql_plan_results }}

Analysis:
- Found needed values → final step only
- Missing values → focused discovery (small LIMIT)
- Be token efficient
{%- else %}
First Iteration

Guide:
- Simple display → Direct answer
- Aggregation/ranking → Schema check + answer
- Entity names → Discovery needed
- Always verify schema first

Limits:
- Structure: LIMIT 3-5
- Discovery: LIMIT 20-50
- Final: No limit for SHOW
{%- endif %}

Available Schema:
{{ memory["sql_metaset"].table_context }}
{%- endblock %}

{% extends 'Agent/main.jinja2' %}

{%- block instructions %}
# Instructions:
Determine the discovery steps needed to answer the user's query.

**Step-by-step:**
1. Identify user-requested values.
2. List only visible enum values; do not assume beyond '...'.
3. If enum shows ['A', 'B', '...']: "Confirmed: A, B. Unconfirmed: after '...'"
4. Provide discovery steps - if values need to be explored first, start with exploration steps, then end with the final analysis.
5. Always provide at least one discovery step.

Rules:
- If previous discoveries found the needed values, provide only the final analysis step
- If requested values aren't visible or need exploration, start with exploration steps
- Only visible enum values are confirmed; never assume others
- Discovery steps: (1) Find all values in columns if needed, (2) Final analysis with confirmed values
- Combine related operations into single steps to avoid fragmentation
{% endblock %}

{% block examples %}
Examples:
Data Schema: 'name' enum ['Alice', 'Bob', 'Charlie', ...], 'year' enum [2020, 2021, 2022], 'region' enum ["North America", "Europe", ...]

1. No Previous Discovery, Incomplete Enum:
User: "Show sales for John in 2022"
- 'John' not in confirmed 'name' values; '2022' is confirmed.
Discovery Steps: ['Explore distinct names containing John', 'Show sales for John in 2022 excluding nulls']

2. No Discovery Needed:
User: "Show who made the most sales in 2020"
- '2020' confirmed
Discovery Steps: ['Show who made the most sales in 2020 excluding nulls']

3. Counter Example:
User: "Which salesperson in the Asian region has the highest revenue?"
'Asia' not in confirmed 'region' values
BAD Discovery Steps: ['Check available regions for Asia or Asian', 'Filter salespeople by Asian region', 'Group by salesperson', 'Sum revenue per salesperson', 'Find maximum revenue', 'Identify top salesperson']
GOOD Discovery Steps: ['Check available regions for Asia or Asian', 'Find the salesperson with highest revenue in the Asian region']
**DON'T do the BAD - too fragmented:**
{% endblock %}

{% block context %}
Please analyze the data context below and provide discovery steps:

{%- if previous_sql_plan_results is defined and previous_sql_plan_results %}
**Previous SQL Plan Results:**
{{ previous_sql_plan_results }}

- If previous SQL plans found the needed values, provide only the final analysis step
- If requested values are still missing, start with exploration steps
{%- else %}
**No Previous SQL Plan Results**
- If requested values aren't visible in schema enums, start with exploration steps
- Always provide at least one discovery step
{%- endif %}

{{ memory["sql_metaset"].selected_context }}
{%- endblock %}
